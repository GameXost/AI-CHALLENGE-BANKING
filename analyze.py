"""
–£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø ML –°–ò–°–¢–ï–ú–ê –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ô –î–õ–Ø –ë–ê–ù–ö–ê v2.0

–£–õ–£–ß–®–ï–ù–ò–Ø:
‚úÖ ~100+ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ (–≤–º–µ—Å—Ç–æ 36)
‚úÖ HDBSCAN –≤–º–µ—Å—Ç–æ DBSCAN (–∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤)
‚úÖ UMAP –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç–∏
‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã (–¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏, —á–∞—Å, —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å)
‚úÖ –ß–∞—Å—Ç–æ—Ç–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
‚úÖ –¢–æ–ø/–∞–Ω—Ç–∏—Ç–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
‚úÖ –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏
‚úÖ –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ —Å —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏
‚úÖ –£–±—Ä–∞–Ω Random Forest (—Ç–æ–ª—å–∫–æ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è)

–ê–†–•–ò–¢–ï–ö–¢–£–†–ê:
1. DataLoader - –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
2. AdvancedFeatureEngineer - —Å–æ–∑–¥–∞–Ω–∏–µ ~100 –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
3. AutoClusterAnalyzer - HDBSCAN + UMAP –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è
4. SmartProductRecommender - –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
5. ClusterVisualizer - –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
"""

import warnings

warnings.filterwarnings('ignore')

# –ò–º–ø–æ—Ä—Ç—ã - –í–ê–ñ–ù–û: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤!
from data_loader import DataLoader
from feature_engineer import AdvancedFeatureEngineer
from cluster_analyzer import AutoClusterAnalyzer
from recommender import SmartProductRecommender
from visualizer import ClusterVisualizer



class UniversalBankingRecommenderV2:
	"""
    –ì–ª–∞–≤–Ω—ã–π –∫–ª–∞—Å—Å ML-—Å–∏—Å—Ç–µ–º—ã —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π v2.0

    –û–°–ù–û–í–ù–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø:
    - –£–±—Ä–∞–Ω Random Forest
    - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω HDBSCAN –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏
    - –†–∞—Å—à–∏—Ä–µ–Ω –Ω–∞–±–æ—Ä –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –¥–æ ~100
    - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
    """

	def __init__(self):
		self.data_loader = DataLoader()
		self.feature_engineer = AdvancedFeatureEngineer()
		self.cluster_analyzer = AutoClusterAnalyzer()
		self.recommender = SmartProductRecommender()
		self.visualizer = ClusterVisualizer()

	def run_complete_system(self, sample_size=200):
		"""
        –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞ ML-—Å–∏—Å—Ç–µ–º—ã

        –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
            sample_size: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 200-500)
        """
		print("\n" + "=" * 70)
		print("üöÄ ML –°–ò–°–¢–ï–ú–ê –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ô v2.0")
		print("   –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è + 100 –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ + HDBSCAN")
		print("=" * 70)

		try:
			# ============================================================
			# 1. –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
			# ============================================================
			print("\nüì¶ –®–ê–ì 1/5: –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•")
			users_df, market_df, payments_df, retail_df = self.data_loader.load_data()

			# ============================================================
			# 2. –°–û–ó–î–ê–ù–ò–ï –ü–†–ò–ó–ù–ê–ö–û–í (~100 —Ñ–∏—á–µ–π)
			# ============================================================
			print("\nüß¨ –®–ê–ì 2/5: –ò–ù–ñ–ï–ù–ï–†–ò–ù–ì –ü–†–ò–ó–ù–ê–ö–û–í")
			feature_matrix, info_df = self.feature_engineer.create_feature_vectors(
				users_df, market_df, payments_df, retail_df, sample_size
			)

			if len(feature_matrix) == 0:
				print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≤–µ–∫—Ç–æ—Ä—ã –ø—Ä–∏–∑–Ω–∞–∫–æ–≤")
				return []

			# ============================================================
			# 3. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ö–õ–ê–°–¢–ï–†–ò–ó–ê–¶–ò–Ø (HDBSCAN + UMAP)
			# ============================================================
			print("\nüî¨ –®–ê–ì 3/5: –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ö–õ–ê–°–¢–ï–†–ò–ó–ê–¶–ò–Ø")
			info_df = self.cluster_analyzer.train_clustering_model(
				feature_matrix, info_df, self.feature_engineer.feature_columns
			)

			# ============================================================
			# 4. –ì–ï–ù–ï–†–ê–¶–ò–Ø –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ô
			# ============================================================
			print("\nüéÅ –®–ê–ì 4/5: –ì–ï–ù–ï–†–ê–¶–ò–Ø –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ô")
			cluster_profiles = self.cluster_analyzer.cluster_profiles
			recommendations = self.recommender.generate_recommendations(
				feature_matrix, info_df, cluster_profiles
			)

			# ============================================================
			# 5. –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø –†–ï–ó–£–õ–¨–¢–ê–¢–û–í
			# ============================================================
			print("\nüìä –®–ê–ì 5/5: –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø")
			self.visualizer.visualize_clusters(
				feature_matrix, info_df, self.feature_engineer.feature_columns
			)

			# ============================================================
			# –ò–¢–û–ì–û–í–´–ô –û–¢–ß–ï–¢
			# ============================================================
			self.recommender.show_results(recommendations)

			print("\n" + "=" * 70)
			print("‚úÖ ML –°–ò–°–¢–ï–ú–ê –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ò–õ–ê –†–ê–ë–û–¢–£")
			print(f"üë§ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {len(recommendations)}")
			print(f"üéØ –°–æ–∑–¥–∞–Ω–æ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤: {len(cluster_profiles)}")
			print(f"üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤: {len(self.feature_engineer.feature_columns)}")
			print("=" * 70)

			return recommendations

		except Exception as e:
			print(f"\n‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: {e}")
			import traceback
			traceback.print_exc()
			return []


def main():
	"""–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞"""

	print("""
    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    ‚ïë   –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø ML –°–ò–°–¢–ï–ú–ê –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ô –î–õ–Ø –ë–ê–ù–ö–ê v2.0      ‚ïë
    ‚ïë                                                              ‚ïë
    ‚ïë   –û–°–ù–û–í–ù–´–ï –í–û–ó–ú–û–ñ–ù–û–°–¢–ò:                                      ‚ïë
    ‚ïë   ‚úì –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è (HDBSCAN)                  ‚ïë
    ‚ïë   ‚úì 100+ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è              ‚ïë
    ‚ïë   ‚úì –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –∫–ª–∞—Å—Ç–µ—Ä–æ–≤                                 ‚ïë
    ‚ïë   ‚úì –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏                        ‚ïë
    ‚ïë   ‚úì –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤                                ‚ïë
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    """)

	# –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ —Å–∏—Å—Ç–µ–º—ã
	recommender = UniversalBankingRecommenderV2()

	# –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞
	# –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 200-500 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏
	results = recommender.run_complete_system(sample_size=200)

	# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
	if results:
		try:
			import pandas as pd
			results_df = pd.DataFrame(results)
			results_df.to_csv('recommendations_output.csv', index=False)
			print(f"\nüíæ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ 'recommendations_output.csv'")
		except Exception as e:
			print(f"\n‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã: {e}")


if __name__ == "__main__":
	main()